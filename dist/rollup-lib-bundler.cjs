/*! @comandeer/rollup-lib-bundler v0.19.0 | (c) 2023 Comandeer | MIT license (see LICENSE) */
"use strict";var e=require("pathe"),t=require("rimraf"),r=require("console-control-strings"),n=require("node:console"),o=require("node:stream"),i=require("@comandeer/cli-spinner"),s=require("node:fs/promises"),a=require("rollup"),c=require("@rollup/plugin-commonjs"),l=require("@rollup/plugin-terser"),u=require("@rollup/plugin-json"),p=require("@rollup/plugin-babel"),d=require("@babel/preset-env"),f=require("rollup-plugin-preserve-shebang"),m=require("@rollup/plugin-typescript"),g=require("rollup-plugin-dts"),h=require("@rollup/plugin-virtual"),w=require("typescript"),b=require("@babel/core");function y(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var v=y(require("@babel/types"));const j=Symbol("stdout"),W=Symbol("stderr"),$=Symbol("spinner");class x{constructor({stdout:e=process.stdout,stderr:t=process.stderr}={}){if(!E(e))throw new TypeError("Custom stdout must be a valid writable/duplex stream");if(!E(t))throw new TypeError("Custom stderr must be a valid writable/duplex stream");this[j]=e,this[W]=t,this.console=new n.Console({stdout:e,stderr:t}),this[$]=new i({label:"Working…",stdout:t}),this.pendingLogs=[],this.pendingWarnings=[]}async showSpinner(){return this[$].show()}async hideSpinner(){return this[$].hide()}addLog(...e){this.pendingLogs.push(e)}addWarning(e){if((t=e)&&"object"==typeof t&&"UNRESOLVED_IMPORT"===t.code)return;var t;const n=function(e){e&&"object"==typeof e&&e.message&&(e=e.message);return`${r.color(["yellow","bold"])}⚠️ Warning!⚠️ ${e}${r.color("reset")}`}(e);this.pendingWarnings.push([n])}display(){this.pendingWarnings.forEach((e=>{this.console.warn(...e)})),this.pendingLogs.forEach((e=>{this.console.log(...e)}))}displayError(e){const t=function({name:e,message:t,stack:n}){const o=n.split("\n");o.shift();const i=o.join("\n");return`${r.color(["bold","red"])}🚨Error🚨\n${e}: ${t}${r.color("reset")}\n${i}`}(e);this.console.error(t)}}function E(e){return e instanceof o.Writable||e instanceof o.Duplex}let q,k;async function C(t){if("string"!=typeof t)throw new TypeError("Provide a path to a package directory.");const r=await async function(t){const r=e.join(t,"package.json");try{await s.access(r)}catch{throw new ReferenceError("The package.json does not exist in the provided location.")}const n=await s.readFile(r,"utf8");let o;try{o=JSON.parse(n)}catch(e){throw new SyntaxError("The package.json file is not parsable as a correct JSON.")}return o}(t);return function(e){var t,r,n;if(void 0===e.name)throw new ReferenceError('Package metadata must contain "name" property.');if(void 0===e.version)throw new ReferenceError('Package metadata must contain "version" property.');if(void 0===(null===(t=e.exports)||void 0===t?void 0:t.import)&&void 0===(null===(r=e.exports)||void 0===r||null===(n=r["."])||void 0===n?void 0:n.import))throw new ReferenceError('Package metadata must contain one of "exports[ \'.\' ].import" or "exports.import" properties or all of them.');if(void 0===e.author)throw new ReferenceError('Package metadata must contain "author" property.');if(void 0===e.license)throw new ReferenceError('Package metadata must contain "license" property.')}(r),async function(t,r){const n=e.normalize(t);return{project:n,name:r.name,version:r.version,author:O(r.author),license:r.license,dist:await S(t,r)}}(t,r)}function O(e){return"object"!=typeof e?String(e):e.name}async function S(t,r){const n=function(e){const t=e.exports,r=Object.keys(t).filter((e=>e.startsWith(".")));r.includes(".")||r.unshift(".");const n=function({bin:e,name:t}){if(void 0===e)return[];if("string"==typeof e)return[`./__bin__/${t}`];const r=Object.keys(e).map((e=>`./__bin__/${e}`));return r}(e);return r.push(...n),r}(r),o=await Promise.all(n.map((n=>async function(t,r,n){const o=await async function(t,r){if(!q){const e=await import("globby");q=e.globby}const n=e.join(t,"src"),o="."===r?"index":r,i=`${o}.{mts,ts,mjs,js,cts,cjs}`,s=await q(i,{cwd:n});return function(t){const r=[".mts",".ts",".mjs",".js",".cts",".cjs"],n=t.sort(((t,n)=>r.indexOf(e.extname(t))-r.indexOf(e.extname(n))));return n[0]}(s)}(t,n),i=e.join("src",o),s=function(e){return e.startsWith("./__bin__")}(n)?function({bin:e,name:t},r){const n=/^\.\/__bin__\//g,o=r.replace(n,"");if(o===t&&"string"==typeof e)return e;return e[o]}(r,n):function(e,t){const r=_(e,t,"import");return r}(r,n),a=function(e,t){const r=_(e,t,"require");return r}(r,n),c=function(e){const t=e.toLowerCase().endsWith("ts");return t?"ts":"js"}(i),l={esm:s,type:c};a&&(l.cjs=a);if("ts"===c){const e=function(e,t){const r=_(e,t,"types");return r}(r,n),o=await async function(e){const t="tsconfig?(.rlb).json",r=await q(t,{cwd:e});if(0===r.length)return null;const n=r.find((e=>e.endsWith(".rlb.json")))||r[0];return n}(t);e&&(l.types=e),o&&(l.tsConfig=o)}return{[i]:l}}(t,r,n))));return[...o].reduce(((e,t)=>({...e,...t})),{})}function _(e,t,r){const n=e.exports;return n[t]?n[t][r]:n[t]||"."!==t?void 0:n[r]}function D(t){const r="\0virtual:src";return{resolveId(n,o){var i;if(!o)return null;const s=e.dirname(o),a=/\.(m|c)?js$/,c=(null===(i=n.match(a))||void 0===i?void 0:i[0])??"";n.endsWith(".d.ts")||(n=`${n.replace(a,"")}.d.ts`);const l=e.join(s,n),u=l.replace(r,"./dist"),p=function(e,t){return Object.entries(e).some((([,{types:e}])=>e===t))}(t,u);if(!p)return l;const d=o.replace(r,"./dist"),f=e.dirname(d);return{id:`./${e.relative(f,u).replace(/\.d\.ts$/,c)}`,external:!0}}}}async function L({packageInfo:t,sourceFile:r,outputFile:n,tsConfig:o,onWarn:i=(()=>{})}={}){if(!k){const e=await import("globby");k=e.globby}const s=t.project,c=function(t,r){if(!r)return{};const n=e.resolve(t,r),o=w.readConfigFile(n,w.sys.readFile),i=w.parseJsonConfigFileContent(o.config,w.sys,t);return i.options}(s,o),l={...c,declaration:!0,emitDeclarationOnly:!0};delete l.outDir,delete l.declarationDir,delete l.outFile,delete l.rootDir;const u=await k("src/**/*.ts",{absolute:!0,cwd:s}),p={},d=w.createCompilerHost(l);d.writeFile=(e,t)=>{const r=P(s,e);p[r]=t};w.createProgram(u,l,d).emit();const f=function(e,t){const r=P(e,t).replace(/\.ts$/,".d.ts");return r}(s,r),m={input:f,plugins:[D(t.dist),h(p),g()],onwarn:i},b={file:n,format:"es"},y=await a.rollup(m);await y.write(b)}function P(e,t){return t.replace(e,"").replace(/^[/\\]/,"")}function F(t,r){return{name:"rlb-resolve-other-bundles",async resolveId(n,o){if(!n.startsWith("."))return null;const i=(await this.resolve(n,o,{skipSelf:!0})).id,s=e.relative(t,i);if(!(void 0!==r[s]))return null;return{id:`rlb:${s}`,external:!0}},async renderChunk(n,o,{file:i}){const s=e.resolve(t,i),{code:a,map:c}=await b.transformAsync(n,{plugins:[I(t,r,s)]});return{code:a,map:c}}}}function I(t,r,n){return{visitor:{ImportDeclaration(e){const{node:t}=e,{value:r}=t.source;if(!r.startsWith("rlb:"))return;const n=o(r,"esm");e.replaceWith(v.importDeclaration(t.specifiers,v.stringLiteral(n)))},ExportNamedDeclaration(e){const{node:t}=e,{source:r}=t;if(!r||!r.value.startsWith("rlb:"))return;const n=o(r.value,"esm");e.replaceWith(v.exportNamedDeclaration(t.declaration,t.specifiers,v.stringLiteral(n)))},ExportAllDeclaration(e){const{node:t}=e,{source:r}=t;if(!r.value.startsWith("rlb:"))return;const n=o(r.value,"esm");e.replaceWith(v.exportAllDeclaration(v.stringLiteral(n)))},CallExpression(e){const{node:t}=e,{callee:r,arguments:n}=t;if(!v.isIdentifier(r)||"require"!==r.name)return;const[i]=n;if(!v.isStringLiteral(i))return;const s=i.value;if(!s.startsWith("rlb:"))return;const a=o(s,"cjs");e.replaceWith(v.callExpression(v.identifier("require"),[v.stringLiteral(a)]))}}};function o(o,i){const s=o.slice(4),a=r[s][i],c=e.resolve(t,a),l=e.dirname(n),u=e.relative(l,c);return u.startsWith(".")?u:`./${u}`}}const R=">=16.0.0".replace(/[<=>~^]/g,"");async function N({onWarn:e,packageInfo:t}){await Promise.all(function(e,t=(()=>{})){const r=Object.entries(e.dist);return r.map((([r,n])=>async function(e,t,r,{onWarn:n=(()=>{})}={}){const o=(w=e,`/*! ${w.name} v${w.version} | (c) ${(new Date).getFullYear()} ${w.author} | ${w.license} license (see LICENSE) */`),i=function(e,t,r,n=(()=>{})){const o=[c(),u(),F(e.project,e.dist),{renderDynamicImport:()=>({left:"import(",right:");"})},p({babelrc:!1,babelHelpers:"bundled",presets:[[d,{targets:{node:R}}]],extensions:[".js",".mjs",".cjs",".ts",".mts",".cts"]}),f(),l()];"ts"===r.type&&o.splice(3,0,m({tsconfig:!!r.tsConfig&&r.tsConfig,declaration:!1}));return{input:t,onwarn:n,plugins:o}}(e,t,r,n),s=T(r.esm,o,"esm"),g=await a.rollup(i),h=[g.write(s)];var w;if(r.cjs){const e=T(r.cjs,o,"cjs");h.push(g.write(e))}else n(`Skipping CJS build for ${t}`);await Promise.all(h),r.types&&await L({packageInfo:e,sourceFile:t,outputFile:r.types,tsConfig:r.tsConfig,onWarn:n})}(e,r,n,{onWarn:t})))}(t,e))}function T(e,t,r="esm"){return{banner:t,sourcemap:!0,format:r,file:e,exports:"auto"}}module.exports=async function(){const n=new x;try{await n.showSpinner();const o=process.cwd(),i=e.resolve(o,"dist");await t.rimraf(i);const s=await C(o);await N({onWarn(e){n.addWarning(e)},packageInfo:s}),n.addLog(`${r.color(["bold","green"])}Bundling complete!${r.color("reset")}`)}catch(e){n.displayError(e),n.addLog(`${r.color(["bold","red"])}Bundling failed!${r.color("reset")}`)}finally{await n.hideSpinner(),n.display()}};
//# sourceMappingURL=rollup-lib-bundler.cjs.map
