/*! @comandeer/rollup-lib-bundler v0.18.0 | (c) 2023 Comandeer | MIT license (see LICENSE) */
"use strict";var e=require("node:path"),t=require("rimraf"),r=require("console-control-strings"),n=require("node:console"),o=require("node:stream"),i=require("@comandeer/cli-spinner"),s=require("node:fs/promises"),a=require("rollup"),c=require("@rollup/plugin-commonjs"),l=require("rollup-plugin-dts"),u=require("@rollup/plugin-terser"),p=require("@rollup/plugin-json"),d=require("@rollup/plugin-babel"),f=require("@babel/preset-env"),m=require("@rollup/plugin-typescript"),w=require("typescript");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var y=g(r),h=g(i),b=g(c),j=g(l),v=g(u),$=g(p),E=g(d),x=g(f),W=g(m),k=g(w);const q=Symbol("stdout"),S=Symbol("stderr"),C=Symbol("spinner");class P{constructor({stdout:e=process.stdout,stderr:t=process.stderr}={}){if(!O(e))throw new TypeError("Custom stdout must be a valid writable/duplex stream");if(!O(t))throw new TypeError("Custom stderr must be a valid writable/duplex stream");this[q]=e,this[S]=t,this.console=new n.Console({stdout:e,stderr:t}),this[C]=new h.default({label:"Working…",stdout:t}),this.pendingLogs=[],this.pendingWarnings=[]}async showSpinner(){return this[C].show()}async hideSpinner(){return this[C].hide()}addLog(...e){this.pendingLogs.push(e)}addWarning(e){if((t=e)&&"object"==typeof t&&"UNRESOLVED_IMPORT"===t.code)return;var t;const r=function(e){e&&"object"==typeof e&&e.message&&(e=e.message);return`${y.default.color(["yellow","bold"])}⚠️ Warning!⚠️ ${e}${y.default.color("reset")}`}(e);this.pendingWarnings.push([r])}display(){this.pendingWarnings.forEach((e=>{this.console.warn(...e)})),this.pendingLogs.forEach((e=>{this.console.log(...e)}))}displayError(e){const t=function({name:e,message:t,stack:r}){const n=r.split("\n");n.shift();const o=n.join("\n");return`${y.default.color(["bold","red"])}🚨Error🚨\n${e}: ${t}${y.default.color("reset")}\n${o}`}(e);this.console.error(t)}}function O(e){return e instanceof o.Writable||e instanceof o.Duplex}let L;async function F(t){if("string"!=typeof t)throw new TypeError("Provide a path to a package directory.");const r=await async function(t){const r=e.join(t,"package.json");try{await s.access(r)}catch{throw new ReferenceError("The package.json does not exist in the provided location.")}const n=await s.readFile(r,"utf8");let o;try{o=JSON.parse(n)}catch(e){throw new SyntaxError("The package.json file is not parsable as a correct JSON.")}return o}(t);return function(e){var t,r,n;if(void 0===e.name)throw new ReferenceError('Package metadata must contain "name" property.');if(void 0===e.version)throw new ReferenceError('Package metadata must contain "version" property.');if(void 0===(null===(t=e.exports)||void 0===t?void 0:t.import)&&void 0===(null===(r=e.exports)||void 0===r||null===(n=r["."])||void 0===n?void 0:n.import))throw new ReferenceError('Package metadata must contain one of "exports[ \'.\' ].import" or "exports.import" properties or all of them.');if(void 0===e.author)throw new ReferenceError('Package metadata must contain "author" property.');if(void 0===e.license)throw new ReferenceError('Package metadata must contain "license" property.')}(r),async function(e,t){return{project:e,name:t.name,version:t.version,author:R(t.author),license:t.license,dist:await D(e,t)}}(t,r)}function R(e){return"object"!=typeof e?String(e):e.name}async function D(t,r){const n=function(e){const t=e.exports,r=Object.keys(t).filter((e=>e.startsWith(".")));r.includes(".")||r.unshift(".");return r}(r),o=await Promise.all(n.map((n=>async function(t,r,n){const o=await async function(t,r){if(!L){const e=await import("globby");L=e.globby}const n=e.join(t,"src"),o="."===r?"index":r,i=`${o}.{mts,ts,mjs,js,cts,cjs}`,s=await L(i,{cwd:n});return function(t){const r=[".mts",".ts",".mjs",".js",".cts",".cjs"],n=t.sort(((t,n)=>r.indexOf(e.extname(t))-r.indexOf(e.extname(n))));return n[0]}(s)}(t,n),i=e.join("src",o),s=function(e,t){const r=T(e,t,"import");return r}(r,n),a=function(e,t){const r=T(e,t,"require");return r}(r,n),c=function(e){const t=e.toLowerCase().endsWith("ts");return t?"ts":"js"}(i),l={esm:s,type:c};a&&(l.cjs=a);if("ts"===c){const e=function(e,t){const r=T(e,t,"types");return r}(r,n),o=await async function(e){const t="tsconfig?(.rlb).json",r=await L(t,{cwd:e});if(0===r.length)return null;const n=r.find((e=>e.endsWith(".rlb.json")))||r[0];return n}(t);e&&(l.types=e),o&&(l.tsConfig=o)}return{[i]:l}}(t,r,n))));return o.reduce(((e,t)=>({...e,...t})),{})}function T(e,t,r){const n=e.exports;return n[t]?n[t][r]:n[t]||"."!==t?null:n[r]}const I=">=16.0.0".replace(/[<=>~^]/g,"");let z,N;async function J({onWarn:t,packageInfo:r}){if(!z){const e=await import("globby");z=e.globby}if(!N){const e=await import("tempy");N=e.temporaryDirectoryTask}await Promise.all(function(t,r=(()=>{})){const n=Object.entries(t.dist);return n.map((([n,o])=>async function(t,r,n,{onWarn:o=(()=>{})}={}){const i=(d=t,`/*! ${d.name} v${d.version} | (c) ${(new Date).getFullYear()} ${d.author} | ${d.license} license (see LICENSE) */`),c=function(e,t,r=(()=>{})){const n=[b.default(),$.default(),{renderDynamicImport:()=>({left:"import(",right:");"})},E.default({babelrc:!1,babelHelpers:"bundled",presets:[[x.default,{targets:{node:I}}]]}),v.default()];"ts"===t.type&&n.splice(2,0,W.default({tsconfig:!!t.tsConfig&&t.tsConfig,declaration:!1}));return{input:e,onwarn:r,plugins:n}}(r,n,o),l=B(n.esm,i,"esm"),u=await a.rollup(c),p=[u.write(l)];var d;if(n.cjs){const e=B(n.cjs,i,"cjs");p.push(u.write(e))}else o(`Skipping CJS build for ${r}`);await Promise.all(p),n.types&&await async function({project:t,sourceFile:r,outputFile:n,onWarn:o=(()=>{})}={}){return t=e.normalize(t),N((async r=>{r=e.normalize(r);const l=(await z("src/**/*.ts",{absolute:!0,cwd:t})).map((t=>e.normalize(t))),u={declaration:!0,emitDeclarationOnly:!0},p={};delete u.declarationDir;const d=k.default.createCompilerHost(u);d.writeFile=(t,r)=>{const n=e.normalize(t);p[n]=r};k.default.createProgram(l,u,d).emit();const f=Object.entries(p).map((async([t,n])=>{const o=c(t),i=e.resolve(r,o),a=e.dirname(i);return await s.mkdir(a,{recursive:!0}),s.writeFile(i,n,{encoding:"utf-8",flag:"w"})}));await Promise.all(f);const m={input:i(r),plugins:[{resolveId:e=>e.startsWith(r)?e:null},j.default()],onwarn:o},w={file:n,format:"es"},g=await a.rollup(m);await g.write(w)}));function i(t){const n=c(r).replace(/\.ts$/,".d.ts");return e.resolve(t,n)}function c(r){return e.normalize(r).replace(t,"").replace(/^[/\\]/,"")}}({project:t.project,sourceFile:r,outputFile:n.types,tsConfig:n.tsConfig,onWarn:o})}(t,n,o,{onWarn:r})))}(r,t))}function B(e,t,r="esm"){return{banner:t,sourcemap:!0,format:r,file:e,exports:"auto"}}module.exports=async function(){const r=new P;try{await r.showSpinner();const n=process.cwd(),o=e.resolve(n,"dist");await t.rimraf(o);const i=await F(n);await J({onWarn(e){r.addWarning(e)},packageInfo:i}),r.addLog(`${y.default.color(["bold","green"])}Bundling complete!${y.default.color("reset")}`)}catch(e){r.displayError(e),r.addLog(`${y.default.color(["bold","red"])}Bundling failed!${y.default.color("reset")}`)}finally{await r.hideSpinner(),r.display()}};
//# sourceMappingURL=rollup-lib-bundler.js.map
