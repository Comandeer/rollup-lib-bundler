/*! @comandeer/rollup-lib-bundler v0.17.0 | (c) 2023 Comandeer | MIT license (see LICENSE) */
"use strict";var t=require("path"),e=require("rimraf"),n=require("console-control-strings"),r=require("console"),o=require("stream"),s=require("@comandeer/cli-spinner"),i=require("fs"),a=require("rollup"),c=require("@rollup/plugin-commonjs"),u=require("rollup-plugin-dts"),l=require("@rollup/plugin-terser"),f=require("@rollup/plugin-json"),p=require("@rollup/plugin-babel"),d=require("@babel/preset-env"),m=require("@rollup/plugin-typescript");function g(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var h=g(n),w=g(s),y=g(c),b=g(u),j=g(l),$=g(f),x=g(p),W=g(d),v=g(m);const S=Symbol("stdout"),q=Symbol("stderr"),E=Symbol("spinner");class k{constructor({stdout:t=process.stdout,stderr:e=process.stderr}={}){if(!C(t))throw new TypeError("Custom stdout must be a valid writable/duplex stream");if(!C(e))throw new TypeError("Custom stderr must be a valid writable/duplex stream");this[S]=t,this[q]=e,this.console=new r.Console({stdout:t,stderr:e}),this[E]=new w.default({label:"Working…",stdout:e}),this.pendingLogs=[],this.pendingWarnings=[]}async showSpinner(){return this[E].show()}async hideSpinner(){return this[E].hide()}addLog(...t){this.pendingLogs.push(t)}addWarning(t){if((e=t)&&"object"==typeof e&&"UNRESOLVED_IMPORT"===e.code)return;var e;const n=function(t){t&&"object"==typeof t&&t.message&&(t=t.message);return`${h.default.color(["yellow","bold"])}⚠️ Warning!⚠️ ${t}${h.default.color("reset")}`}(t);this.pendingWarnings.push([n])}display(){this.pendingWarnings.forEach((t=>{this.console.warn(...t)})),this.pendingLogs.forEach((t=>{this.console.log(...t)}))}displayError(t){const e=function({name:t,message:e,stack:n}){const r=n.split("\n");r.shift();const o=r.join("\n");return`${h.default.color(["bold","red"])}🚨Error🚨\n${t}: ${e}${h.default.color("reset")}\n${o}`}(t);this.console.error(e)}}function C(t){return t instanceof o.Writable||t instanceof o.Duplex}let L;async function O(e){if("string"!=typeof e)throw new TypeError("Provide a path to a package directory.");const n=function(e){const n=t.join(e,"package.json");if(!i.existsSync(n))throw new ReferenceError("The package.json does not exist in the provided location.");const r=i.readFileSync(n,"utf8");let o;try{o=JSON.parse(r)}catch(t){throw new SyntaxError("The package.json file is not parsable as a correct JSON.")}return o}(e);return function(t){function e(e){if(void 0===t[e])throw new ReferenceError(`Package metadata must contain "${e}" property.`)}function n(...e){if(!e.some((e=>{const n=e.split("/");return r(t,n)})))throw new ReferenceError(`Package metadata must contain one of ${o(e)} properties or all of them.`)}function r(t,e){const n=e.shift();return void 0!==t[n]&&(0===e.length||r(t[n],e))}function o(t){return t.map(((n,r)=>{const o=`"${e(n)}"`;if(0===r)return o;return`${r===t.length-1?" or ":", "}${o}`})).join("");function e(t){const e=/(\/)/g;return t.split(e).reduce(((t,e)=>{const n=t[t.length-1];return e.startsWith(".")&&"."===n?[...t.slice(0,-1),"[ '",e]:"/"===e&&n.startsWith(".")?[...t,"' ]."]:"/"===e?[...t,"."]:[...t,e]}),[]).join("")}}e("name"),e("version"),n("exports/./import","exports/import","module","jsnext:main"),e("author"),e("license")}(n),async function(t,e){return{name:e.name,version:e.version,author:P(e.author),license:e.license,dist:await F(t,e)}}(e,n)}function P(t){return"object"!=typeof t?String(t):t.name}async function F(e,n){const r=function(t){const e=t.exports;if(!e)return["."];const n=Object.keys(e).filter((t=>t.startsWith(".")));n.includes(".")||n.unshift(".");return n}(n),o=await Promise.all(r.map((r=>async function(e,n,r){const o=await async function(e,n){if(!L){const t=await import("globby");L=t.globby}const r=t.join(e,"src"),o="."===n?"index":n,s=`${o}.{mts,ts,mjs,js,cts,cjs}`,i=await L(s,{cwd:r});return function(e){const n=[".mts",".ts",".mjs",".js",".cts",".cjs"],r=e.sort(((e,r)=>n.indexOf(t.extname(e))-n.indexOf(t.extname(r))));return r[0]}(i)}(e,r),s=t.join("src",o),i=function(t,e){const n=T(t,e,"import");if("."===e)return n||t.module||t["jsnext:main"];return n}(n,r),a=function(t,e){const n=T(t,e,"require");if("."===e)return n||t.main;return n}(n,r),c=function(t){const e=t.toLowerCase().endsWith("ts");return e?"ts":"js"}(s),u={esm:i,type:c};a&&(u.cjs=a);if("ts"===c){const t=function(t,e){const n=T(t,e,"types");if("."===e)return n||t.types;return n}(n,r),o=await async function(t){const e="tsconfig?(.rlb).json",n=await L(e,{cwd:t});if(0===n.length)return null;const r=n.find((t=>t.endsWith(".rlb.json"))),o=r||n[0];return o}(e);t&&(u.types=t),o&&(u.tsConfig=o)}return{[s]:u}}(e,n,r))));return o.reduce(((t,e)=>({...t,...e})),{})}function T(t,e,n){if(!t.exports)return null;const r=t.exports;return r[e]?r[e][n]:r[e]||"."!==e?null:r[n]}const I=">=16.0.0".replace(/[<=>~^]/g,"");let R;async function D({onWarn:n,packageInfo:r}){if(!R){const t=await import("globby");R=t.globby}await Promise.all(function(e,n=(()=>{})){const r=Object.entries(e.dist);return r.map((([r,o])=>async function(e,n,r,{onWarn:o=(()=>{})}={}){const s=(f=e,`/*! ${f.name} v${f.version} | (c) ${(new Date).getFullYear()} ${f.author} | ${f.license} license (see LICENSE) */`),i=function(t,e,n=(()=>{})){const r=[y.default(),$.default(),{renderDynamicImport:()=>({left:"import(",right:");"})},x.default({babelrc:!1,babelHelpers:"bundled",presets:[[W.default,{targets:{node:I}}]]}),j.default()];"ts"===e.type&&r.splice(2,0,v.default({tsconfig:!!e.tsConfig&&e.tsConfig}));return{input:t,onwarn:n,plugins:r}}(n,r,o),c=N(r.esm,s,"esm"),u=await a.rollup(i),l=[u.write(c)];var f;if(r.cjs){const t=N(r.cjs,s,"cjs");l.push(u.write(t))}else o(`Skipping CJS build for ${n}`);await Promise.all(l),r.types&&await async function({sourceFile:e,outputFile:n,onWarn:r=(()=>{})}={}){const o={input:c(),plugins:[b.default()],onwarn:r},s={file:n,format:"es"},i=await a.rollup(o);function c(){const r=`${t.basename(e,".ts")}.d.ts`,o=t.dirname(n);return t.resolve(o,r)}await i.write(s)}({sourceFile:n,outputFile:r.types,onWarn:o})}(e,r,o,{onWarn:n})))}(r,n)),await async function(n){const r=Object.entries(n.dist),o=r.reduce(((t,[,e])=>(e.types&&t.push(e.types),t)),[]);if(0===o.length)return;const s=t.dirname(o[0]),i=(await R(["**/*.d.ts"],{cwd:s,absolute:!0})).filter((t=>!o.includes(t)));return e.rimraf(i)}(r)}function N(t,e,n="esm"){return{banner:e,sourcemap:!0,format:n,file:t,exports:"auto"}}module.exports=async function(){const n=new k;try{await n.showSpinner();const r=process.cwd(),o=t.resolve(r,"dist");await e.rimraf(o);const s=await O(r);await D({onWarn(t){n.addWarning(t)},packageInfo:s}),n.addLog(`${h.default.color(["bold","green"])}Bundling complete!${h.default.color("reset")}`)}catch(t){n.displayError(t),n.addLog(`${h.default.color(["bold","red"])}Bundling failed!${h.default.color("reset")}`)}finally{await n.hideSpinner(),n.display()}};
//# sourceMappingURL=rollup-lib-bundler.js.map
