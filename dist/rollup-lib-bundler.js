/*! @comandeer/rollup-lib-bundler v0.15.0 | (c) 2022 Comandeer | MIT license (see LICENSE) */
"use strict";var e=require("path"),r=require("rimraf"),n=require("console-control-strings"),t=require("console"),o=require("stream"),s=require("@comandeer/cli-spinner"),i=require("fs"),a=require("rollup"),u=require("@rollup/plugin-commonjs"),c=require("rollup-plugin-terser"),l=require("@rollup/plugin-json"),d=require("@rollup/plugin-babel"),f=require("@babel/preset-env");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=p(r),m=p(n),g=p(s),w=p(u),b=p(l),y=p(d),$=p(f);const j=Symbol("stdout"),v=Symbol("stderr"),x=Symbol("spinner");class q{constructor({stdout:e=process.stdout,stderr:r=process.stderr}={}){if(!E(e))throw new TypeError("Custom stdout must be a valid writable/duplex stream");if(!E(r))throw new TypeError("Custom stderr must be a valid writable/duplex stream");this[j]=e,this[v]=r,this.console=new t.Console({stdout:e,stderr:r}),this[x]=new g.default({label:"Working…",stdout:r}),this.pendingLogs=[],this.pendingWarnings=[]}async showSpinner(){return this[x].show()}async hideSpinner(){return this[x].hide()}addLog(...e){this.pendingLogs.push(e)}addWarning(e){if((r=e)&&"object"==typeof r&&"UNRESOLVED_IMPORT"===r.code)return;var r;const n=function(e){e&&"object"==typeof e&&e.message&&(e=e.message);return`${m.default.color(["yellow","bold"])}⚠️ Warning!⚠️ ${e}${m.default.color("reset")}`}(e);this.pendingWarnings.push([n])}display(){this.pendingWarnings.forEach((e=>{this.console.warn(...e)})),this.pendingLogs.forEach((e=>{this.console.log(...e)}))}displayError(e){const r=function({name:e,message:r,stack:n}){const t=n.split("\n");t.shift();const o=t.join("\n");return`${m.default.color(["bold","red"])}🚨Error🚨\n${e}: ${r}${m.default.color("reset")}\n${o}`}(e);this.console.error(r)}}function E(e){return e instanceof o.Writable||e instanceof o.Duplex}function W(e){if("string"==typeof e)e=function(e){if(!i.existsSync(e))throw new ReferenceError("File with given path does not exist.");const r=i.readFileSync(e,"utf8");let n;try{n=JSON.parse(r)}catch(e){throw new SyntaxError("Given file is not parsable as a correct JSON.")}return n}(e);else if("object"!=typeof e)throw new TypeError("Provide string or object.");return function(e){function r(r){if(void 0===e[r])throw new ReferenceError(`Package metadata must contain "${r}" property.`)}function n(...r){if(!r.some((r=>{const n=r.split("/");return t(e,n)})))throw new ReferenceError(`Package metadata must contain one of ${o(r)} properties or all of them.`)}function t(e,r){const n=r.shift();return void 0!==e[n]&&(0===r.length||t(e[n],r))}function o(e){return e.map(((n,t)=>{const o=`"${r(n)}"`;if(0===t)return o;return`${t===e.length-1?" or ":", "}${o}`})).join("");function r(e){const r=/(\/)/g;return e.split(r).reduce(((e,r)=>{const n=e[e.length-1];return r.startsWith(".")&&"."===n?[...e.slice(0,-1),"[ '",r]:"/"===r&&n.startsWith(".")?[...e,"' ]."]:"/"===r?[...e,"."]:[...e,r]}),[]).join("")}}r("name"),r("version"),n("exports/./require","exports/require","main"),n("exports/./import","exports/import","module","jsnext:main"),r("author"),r("license")}(e),function(e){return{name:e.name,version:e.version,author:S(e.author),license:e.license,dist:k(e)}}(e)}function S(e){return"object"!=typeof e?String(e):e.name}function k(r){const n=function(e){const r=e.exports;if(!r)return["."];const n=Object.keys(r).filter((e=>e.startsWith(".")));n.includes(".")||n.unshift(".");return n}(r);return n.reduce(((n,t)=>{const o=function(r,n){const t="."===n?"index":n,o=t.endsWith(".js")?t:`${t}.js`,s=e.join("src",o),i=function(e,r){const n=L(e,r,"import");if("."===r)return n||e.module||e["jsnext:main"];return n}(r,n),a=function(e,r){const n=L(e,r,"require");if("."===r)return n||e.main;return n}(r,n);return{[s]:{esm:i,cjs:a}}}(r,t);return{...n,...o}}),{})}function L(e,r,n){if(!e.exports)return null;const t=e.exports;return t[r]?t[r][n]:t[r]||"."!==r?null:t[n]}const P=">=12.0.0".replace(/[<=>~^]/g,"");async function O({onWarn:e,packageInfo:r}){await Promise.all(function(e,r=(()=>{})){return Object.entries(e.dist).map((([n,t])=>async function(e,r,n,{onWarn:t=(()=>{})}={}){const o=(d=e,`/*! ${d.name} v${d.version} | (c) ${(new Date).getFullYear()} ${d.author} | ${d.license} license (see LICENSE) */`),s=function(e,r=(()=>{})){const n=[w.default(),b.default(),y.default({babelrc:!1,babelHelpers:"bundled",presets:[[$.default,{targets:{node:P}}]]}),c.terser()];return{input:e,onwarn:r,plugins:n}}(r,t),i=R(n.cjs,o,"cjs"),u=R(n.esm,o,"esm"),l=await a.rollup(s);var d;await Promise.all([l.write(i),l.write(u)])}(e,n,t,{onWarn:r})))}(r,e))}function R(e,r,n="esm"){return{banner:r,sourcemap:!0,format:n,file:e,exports:"auto"}}module.exports=async function(){const r=new q;try{await r.showSpinner();const n=e.resolve(process.cwd(),"dist");await function(e){return new Promise(((r,n)=>{h.default(e,(e=>{if(e)return n(e);r()}))}))}(n);const t=W("package.json");await O({onWarn(e){r.addWarning(e)},packageInfo:t}),r.addLog(`${m.default.color(["bold","green"])}Bundling complete!${m.default.color("reset")}`)}catch(e){r.displayError(e),r.addLog(`${m.default.color(["bold","red"])}Bundling failed!${m.default.color("reset")}`)}finally{await r.hideSpinner(),r.display()}};
//# sourceMappingURL=rollup-lib-bundler.js.map
