{"version":3,"file":"rollup-lib-bundler.js","sources":["../src/OutputController.js","../src/packageParser.js","../src/targets.js","../src/bundler.js","../src/generateBanner.js","../src/rlb.js"],"sourcesContent":["import { Console } from 'console';\nimport { Writable as WritableStream } from 'stream';\nimport { Duplex as DuplexStream } from 'stream';\nimport Gauge from 'gauge';\nimport consoleControlStrings from 'console-control-strings';\n\nconst stdoutSymbol = Symbol( 'stdout' );\nconst stderrSymbol = Symbol( 'stderr' );\nconst gaugeSymbol = Symbol( 'gauge' );\nconst gaugeTimeoutSymbol = Symbol( 'gaugeTimeout' );\n\nclass OutputController {\n\tconstructor( {\n\t\tstdout = process.stdout,\n\t\tstderr = process.stderr\n\t} = {} ) {\n\t\tif ( !isValidStream( stdout ) ) {\n\t\t\tthrow new TypeError( 'Custom stdout must be a valid writable/duplex stream' );\n\t\t}\n\n\t\tif ( !isValidStream( stderr ) ) {\n\t\t\tthrow new TypeError( 'Custom stderr must be a valid writable/duplex stream' );\n\t\t}\n\n\t\tthis[ stdoutSymbol ] = stdout;\n\t\tthis[ stderrSymbol ] = stderr;\n\t\tthis.console = new Console( {\n\t\t\tstdout,\n\t\t\tstderr\n\t\t} );\n\t\tthis[ gaugeSymbol ] = new Gauge( stdout, {\n\t\t\tenabled: true,\n\t\t\ttemplate: [\n\t\t\t\t{\n\t\t\t\t\ttype: 'activityIndicator',\n\t\t\t\t\tkerning: 1,\n\t\t\t\t\tlength: 1\n\t\t\t\t},\n\n\t\t\t\t{\n\t\t\t\t\ttype: 'section',\n\t\t\t\t\tkerning: 1,\n\t\t\t\t\tdefault: 'Workingâ€¦'\n\t\t\t\t}\n\t\t\t]\n\t\t} );\n\t\tthis[ gaugeTimeoutSymbol ] = null;\n\t\tthis.pending = [];\n\t}\n\n\t/* istanbul ignore next */\n\tshowGauge() {\n\t\tconst pulse = () => {\n\t\t\tthis[ gaugeSymbol ].pulse();\n\t\t\tthis[ gaugeTimeoutSymbol ] = setTimeout( pulse, 50 );\n\t\t};\n\n\t\tthis[ gaugeSymbol ].show( 'Workingâ€¦' );\n\t\tpulse();\n\t}\n\n\t/* istanbul ignore next */\n\thideGauge() {\n\t\tclearTimeout( this[ gaugeTimeoutSymbol ] );\n\t\tthis[ gaugeSymbol ].hide();\n\n\t\tthis[ gaugeTimeoutSymbol ] = null;\n\t}\n\n\taddLog( ...args ) {\n\t\tthis.pending.push( args );\n\t}\n\n\taddWarning( log ) {\n\t\tif ( isExternalDepWarning( log ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst warning = createWarning( log );\n\n\t\tthis.pending.push( [ warning ] );\n\t}\n\n\tdisplay() {\n\t\tthis.pending.forEach( ( log ) => {\n\t\t\tthis.console.log( ...log );\n\t\t} );\n\t}\n\n\tdisplayError( error ) {\n\t\tconst errorLog = createError( error );\n\n\t\tthis.console.error( errorLog );\n\t}\n}\n\nfunction isValidStream( value ) {\n\treturn value instanceof WritableStream || value instanceof DuplexStream;\n}\n\nfunction isExternalDepWarning( log ) {\n\treturn log && typeof log === 'object' && log.code === 'UNRESOLVED_IMPORT';\n}\n\nfunction createWarning( warning ) {\n\tif ( warning && typeof warning === 'object' && warning.message ) {\n\t\twarning = warning.message;\n\t}\n\n\treturn `${ consoleControlStrings.color( [ 'yellow', 'bold' ] ) }âš ï¸ Warning!âš ï¸ ${ warning }${ consoleControlStrings.color( 'reset' ) }`;\n}\n\nfunction createError( { name, message, stack } ) {\n\tconst stackParts = stack.split( '\\n' );\n\n\tstackParts.shift();\n\n\tconst newStack = stackParts.join( '\\n' );\n\n\treturn `${ consoleControlStrings.color( [ 'bold', 'red' ] ) }ðŸš¨ErrorðŸš¨\n${ name }: ${ message }${ consoleControlStrings.color( 'reset' ) }\n${ newStack }`;\n}\n\nexport default OutputController;\n","import { existsSync } from 'fs';\nimport { readFileSync } from 'fs';\n\nfunction packageParser( metadata ) {\n\tif ( typeof metadata === 'string' ) {\n\t\tmetadata = loadAndParseFile( metadata );\n\t} else if ( typeof metadata !== 'object' ) {\n\t\tthrow new TypeError( 'Provide string or object.' );\n\t}\n\n\tlintObject( metadata );\n\n\treturn prepareMetadata( metadata );\n}\n\nfunction loadAndParseFile( path ) {\n\tif ( !existsSync( path ) ) {\n\t\tthrow new ReferenceError( 'File with given path does not exist.' );\n\t}\n\n\tconst contents = readFileSync( path, 'utf8' );\n\tlet parsed;\n\n\ttry {\n\t\tparsed = JSON.parse( contents );\n\t} catch ( e ) {\n\t\tthrow new SyntaxError( 'Given file is not parsable as a correct JSON.' );\n\t}\n\n\treturn parsed;\n}\n\nfunction lintObject( obj ) {\n\tcheckProperty( 'name' );\n\tcheckProperty( 'version' );\n\tcheckProperties( 'exports.require', 'main' );\n\tcheckProperties( 'exports.import', 'module', 'jsnext:main' );\n\tcheckProperty( 'author' );\n\tcheckProperty( 'license' );\n\n\tfunction checkProperty( name ) {\n\t\tif ( typeof obj[ name ] === 'undefined' ) {\n\t\t\tthrow new ReferenceError( `Package metadata must contain \"${ name }\" property.` );\n\t\t}\n\t}\n\n\tfunction checkProperties( ...properties ) {\n\t\tconst isAtLeastOnePresent = properties.some( ( property ) => {\n\t\t\tconst propertyPath = property.split( '.' );\n\n\t\t\treturn checkPropertyExistence( obj, propertyPath );\n\t\t} );\n\n\t\tif ( !isAtLeastOnePresent ) {\n\t\t\tthrow new ReferenceError( `Package metadata must contain one of ${ prepareNamesForError( properties ) } properties or all of them.` );\n\t\t}\n\t}\n\n\tfunction checkPropertyExistence( obj, propertyPath ) {\n\t\tconst currentProperty = propertyPath.shift();\n\n\t\tif ( typeof obj[ currentProperty ] === 'undefined' ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif ( propertyPath.length === 0 ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn checkPropertyExistence( obj[ currentProperty ], propertyPath );\n\t}\n\n\tfunction prepareNamesForError( names ) {\n\t\treturn names.map( ( name, i ) => {\n\t\t\tconst quotedName = `\"${ name }\"`;\n\n\t\t\tif ( i === 0 ) {\n\t\t\t\treturn quotedName;\n\t\t\t}\n\n\t\t\tconst conjuction = ( i === names.length - 1 ) ? ' or ' : ', ';\n\n\t\t\treturn `${ conjuction}${ quotedName }`;\n\t\t} ).join( '' );\n\t}\n}\n\nfunction prepareMetadata( obj ) {\n\treturn {\n\t\tname: obj.name,\n\t\tversion: obj.version,\n\t\tauthor: prepareAuthorMetadata( obj.author ),\n\t\tlicense: obj.license,\n\t\tsrc: 'src/index.js',\n\t\tdist: {\n\t\t\tesm: getESMTarget( obj ),\n\t\t\tcjs: getCJSTarget( obj )\n\t\t}\n\t};\n}\n\nfunction prepareAuthorMetadata( author ) {\n\tif ( typeof author !== 'object' ) {\n\t\treturn String( author );\n\t}\n\n\treturn author.name;\n}\n\nfunction getESMTarget( obj ) {\n\tif ( obj.exports && obj.exports.import ) {\n\t\treturn obj.exports.import;\n\t}\n\n\treturn obj.module || obj[ 'jsnext:main' ];\n}\n\nfunction getCJSTarget( obj ) {\n\tif ( obj.exports && obj.exports.require ) {\n\t\treturn obj.exports.require;\n\t}\n\n\treturn obj.main;\n}\n\nexport default packageParser;\n","import { engines } from '../package.json';\n\nconst node = engines.node.replace( /[<=>~^]/g, '' );\n\nexport { node };\n","import { rollup } from 'rollup';\nimport convertCJS from '@rollup/plugin-commonjs';\nimport { terser } from 'rollup-plugin-terser';\nimport json from '@rollup/plugin-json';\nimport babel from '@rollup/plugin-babel';\nimport preset from '@babel/preset-env';\nimport generateBanner from './generateBanner.js';\nimport { node as nodeTarget } from './targets.js';\n\nasync function bundler( {\n\tonWarn,\n\tpackageInfo\n} ) {\n\tconst inputConfig = getRollupInputConfig( packageInfo, onWarn );\n\tconst outputConfigCJS = getRollupOutputConfig( packageInfo, 'cjs' );\n\tconst otuputConfigESM = getRollupOutputConfig( packageInfo, 'esm' );\n\n\tconst bundle = await rollup( inputConfig );\n\n\tawait Promise.all( [\n\t\tbundle.write( outputConfigCJS ),\n\t\tbundle.write( otuputConfigESM )\n\t] );\n}\n\nfunction getRollupInputConfig( metadata, onwarn = () => {} ) {\n\tconst plugins = [\n\t\tconvertCJS(),\n\n\t\tjson(),\n\n\t\tbabel( {\n\t\t\tbabelrc: false,\n\t\t\tbabelHelpers: 'bundled',\n\t\t\tpresets: [\n\t\t\t\t[\n\t\t\t\t\tpreset,\n\t\t\t\t\t{\n\t\t\t\t\t\ttargets: {\n\t\t\t\t\t\t\tnode: nodeTarget\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t]\n\t\t} ),\n\n\t\tterser()\n\t];\n\n\treturn {\n\t\tinput: metadata.src,\n\t\tonwarn,\n\t\tplugins\n\t};\n}\n\nfunction getRollupOutputConfig( metadata, format = 'esm' ) {\n\tconst banner = generateBanner( metadata );\n\n\treturn {\n\t\tbanner,\n\t\tsourcemap: true,\n\t\tformat,\n\t\tfile: metadata.dist[ format ],\n\t\texports: 'auto'\n\t};\n}\n\nexport default bundler;\n","function generateBanner( metadata ) {\n\treturn `/*! ${metadata.name} v${metadata.version} | (c) ${new Date().getFullYear()} ${metadata.author} | ${metadata.license} license (see LICENSE) */`;\n}\n\nexport default generateBanner;\n","/* istanbul ignore file */\nimport consoleControlStrings from 'console-control-strings';\nimport OutputController from './OutputController.js';\nimport packageParser from './packageParser.js';\nimport bundler from './bundler.js';\n\nasync function rlb() {\n\tconst outputController = new OutputController();\n\n\ttry {\n\t\toutputController.showGauge();\n\n\t\tconst packageInfo = packageParser( 'package.json' );\n\n\t\tawait bundler( {\n\t\t\tonWarn( warning ) {\n\t\t\t\toutputController.addWarning( warning );\n\t\t\t},\n\t\t\tpackageInfo\n\t\t} );\n\n\t\toutputController.addLog( `${ consoleControlStrings.color( [ 'bold', 'green' ] ) }Bundling complete!${ consoleControlStrings.color( 'reset' ) }` );\n\t} catch ( error ) {\n\t\toutputController.displayError( error );\n\t\toutputController.addLog( `${ consoleControlStrings.color( [ 'bold', 'red' ] ) }Bundling failed!${ consoleControlStrings.color( 'reset' ) }` );\n\t} finally {\n\t\toutputController.hideGauge();\n\t\toutputController.display();\n\t}\n}\n\nexport default rlb;\n"],"names":["stdoutSymbol","Symbol","stderrSymbol","gaugeSymbol","gaugeTimeoutSymbol","OutputController","constructor","stdout","process","stderr","isValidStream","TypeError","console","Console","Gauge","enabled","template","type","kerning","length","default","pending","showGauge","pulse","setTimeout","show","hideGauge","clearTimeout","this","hide","addLog","args","push","addWarning","log","code","isExternalDepWarning","warning","message","consoleControlStrings","color","createWarning","display","forEach","displayError","error","errorLog","name","stack","stackParts","split","shift","newStack","join","createError","value","WritableStream","DuplexStream","packageParser","metadata","path","existsSync","ReferenceError","contents","readFileSync","parsed","JSON","parse","e","SyntaxError","loadAndParseFile","obj","checkProperty","checkProperties","properties","some","property","propertyPath","checkPropertyExistence","prepareNamesForError","currentProperty","names","map","i","quotedName","lintObject","version","author","prepareAuthorMetadata","license","src","dist","esm","getESMTarget","cjs","getCJSTarget","String","exports","import","module","require","main","node","replace","async","bundler","onWarn","packageInfo","inputConfig","onwarn","plugins","convertCJS","json","babel","babelrc","babelHelpers","presets","preset","targets","nodeTarget","terser","input","getRollupInputConfig","outputConfigCJS","getRollupOutputConfig","otuputConfigESM","bundle","rollup","Promise","all","write","format","banner","Date","getFullYear","generateBanner","sourcemap","file","outputController"],"mappings":"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"}